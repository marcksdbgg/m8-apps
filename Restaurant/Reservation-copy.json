{
  "name": "Reservation-copy",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "id": "55f625f0-dee4-4ac1-9cf5-e6b7b9b10b2f",
      "name": "WhatsApp Trigger",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -1312,
        400
      ],
      "webhookId": "b683d199-d836-4837-b0f3-4501a158747f",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "yrZgHUs4XTfTRn5A",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "location"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Ubicaci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "interactive"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Interactivo"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "image"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Imagen"
            }
          ]
        },
        "options": {}
      },
      "id": "65020046-4faf-4d4d-9371-c9457113def9",
      "name": "Switch - Tipo de mensaje",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1072,
        352
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sc1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $json.messages[0].from }}"
            },
            {
              "id": "sc2",
              "name": "nombre",
              "type": "string",
              "value": "={{ $json.contacts && $json.contacts[0] && $json.contacts[0].profile && $json.contacts[0].profile.name ? $json.contacts[0].profile.name : ($json.messages[0].text && $json.messages[0].text.body ? $json.messages[0].text.body : '') }}"
            },
            {
              "id": "sc3",
              "name": "primerMensaje",
              "type": "string",
              "value": "={{ $json.messages[0].text && $json.messages[0].text.body ? $json.messages[0].text.body : '' }}"
            },
            {
              "id": "sc4",
              "name": "metadata",
              "type": "json",
              "value": "={{ $json }}"
            },
            {
              "id": "sc5",
              "name": "telefonoPedidos",
              "type": "string",
              "value": "+51-987654321"
            },
            {
              "id": "sc6",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $json.metadata && $json.metadata.phone_number_id ? $json.metadata.phone_number_id : '' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f11cf529-69ab-44f4-90a9-f9ddf7565c6b",
      "name": "Set - Datos Cliente",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -736,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $node[\"Set - Datos Cliente\"].json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  recipient_type: 'individual',\n  to: $json.telefono,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    body: {\n      text: $json.mensaje\n    },\n    action: {\n      buttons: [\n        {\n          type: 'reply',\n          reply: { id: 'VER_MENU', title: 'üåÆ Ver men√∫' }\n        },\n        {\n          type: 'reply',\n          reply: { id: 'HACER_PEDIDO', title: 'üõµ Hacer pedido' }\n        }\n      ]\n    }\n  }\n}) }}",
        "options": {}
      },
      "id": "56d97319-c64f-4979-a0d0-f79ee321df00",
      "name": "HTTP - Enviar Mensaje Interactivo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        848,
        -16
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.ai_prompt_input }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=ERES UN AUDITOR DE PAGOS DIGITALES (IA DE VISI√ìN). TU FUNCI√ìN ES CR√çTICA Y BINARIA: EXTRAER DATOS O RECHAZAR.\n\n### 1. JERARQU√çA DE VISI√ìN (QU√â BUSCAR Y D√ìNDE)\nEscanea la imagen de arriba a abajo siguiendo estrictamente este orden:\n\n**PRIORIDAD A (OBLIGATORIOS - SI FALTA UNO, EL PROCESO FALLA):**\n\n1.  **EL MONTO (Decimal):**\n    * *Pista Visual:* Busca el s√≠mbolo de moneda \"S/\" o \"S/.\" seguido de n√∫meros grandes en la parte superior/central.\n    * *En tu imagen de referencia:* Aparece como \"S/ 51\".\n    * *Regla:* Extrae SOLO el valor num√©rico (ej: 51.00). Ignora saldos o textos peque√±os.\n\n2.  **EL C√ìDIGO DE SEGURIDAD (String de 3 d√≠gitos exactos):**\n    * *Pista Visual 1 (YAPE NUEVO):* Busca la etiqueta literal \"C√ìDIGO DE SEGURIDAD\". Justo a la derecha ver√°s tres recuadros o d√≠gitos separados (ej: 7 6 2). ESTA ES LA FUENTE DE VERDAD.\n    * *Pista Visual 2 (PLIN/YAPE VIEJO):* Si NO existe la etiqueta anterior, busca el \"N√∫mero de Operaci√≥n\" o \"Nro. de operaci√≥n\" en la parte inferior y extrae los **√öLTIMOS 3 D√çGITOS**.\n    * *Regla:* Debe ser un string de exactamente 3 caracteres num√©ricos.\n\n**PRIORIDAD B (OPCIONALES PERO IMPORTANTES):**\n\n3.  **ORIGEN (String):**\n    * *Pista:* Logo en la esquina (Yape es morado, Plin es celeste/amarillo).\n    * *Salida:* \"Yape\", \"Plin\", \"Interbank\", o null.\n\n4.  **ES_VOUCHER_PAGADO (Boolean):**\n    * *Pista:* Busca frases de √©xito como \"¬°Yapeaste!\", \"Pago Exitoso\", \"Transferencia exitosa\".\n    * *Regla:* Si la imagen parece un error, saldo insuficiente o flujo incompleto, devuelve `false`.\n\n---\n\n### 2. REGLAS DE FORMATO Y RESPUESTA (CR√çTICO)\n- **USO DE HERRAMIENTA:** Debes llamar a la funci√≥n/tool configurada (`format_final_json_response` o equivalente) con los datos extra√≠dos.\n- **ESTRUCTURA PLANA:** Pasa los par√°metros `monto`, `codigo_seguridad`, `origen`, etc., directamente.\n- **PROHIBICIONES:**\n  - NO envuelvas la respuesta en un objeto `{ \"output\": ... }`.\n  - NO envuelvas la respuesta en bloques markdown (```json).\n  - NO devuelvas texto conversacional (\"Aqu√≠ est√° tu JSON\"). SOLO EJECUTA LA HERRAMIENTA.\n\n### 3. MANEJO DE ERRORES\n- Si la imagen es borrosa, recortada (no se ve el monto) o ilegible:\n  - `monto`: 0\n  - `codigo_seguridad`: null\n  - `es_voucher_pagado`: false\n  - `nota_modelo`: \"Imagen ilegible o datos incompletos\"."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        208,
        304
      ],
      "id": "df185760-8d65-4ed3-b789-840c3c491d88",
      "name": "AI Agent",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 500
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-nano",
          "mode": "list",
          "cachedResultName": "gpt-5-nano"
        },
        "builtInTools": {},
        "options": {
          "reasoningEffort": "low"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        112,
        560
      ],
      "id": "f6a1eaa2-2e29-41ed-9fff-3097c6b800d2",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "dsdD6fRvsQt0GXeH",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Set - Datos Cliente').first().json.telefono }}",
        "tableName": "historial_conversaciones",
        "contextWindowLength": 2
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        256,
        560
      ],
      "id": "119a6d1d-e4cf-4ba2-a14a-3041a8a70c9a",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "btn1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $json.messages[0].from }}"
            },
            {
              "id": "btn2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $json.metadata.phone_number_id }}"
            },
            {
              "id": "btn3",
              "name": "buttonId",
              "type": "string",
              "value": "={{ $json.messages[0].interactive.button_reply.id }}"
            },
            {
              "id": "btn4",
              "name": "buttonTitle",
              "type": "string",
              "value": "={{ $json.messages[0].interactive.button_reply.title }}"
            }
          ]
        },
        "options": {}
      },
      "id": "96c8a311-a2e5-4fc0-87df-efe5f816a47a",
      "name": "Set - Datos Bot√≥n WhatsApp",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -800,
        560
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.buttonId }}",
                    "rightValue": "VER_MENU",
                    "id": "02b82466-4afc-4019-a545-071468a1b84c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "VerMen√∫"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.buttonId }}",
                    "rightValue": "HACER_PEDIDO",
                    "id": "8deb3aa2-4abd-427f-8b2e-2a63aa02b2de"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HacerPedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.buttonId }}",
                    "rightValue": "PEDIDO_RECOJO",
                    "id": "64aa0f28-bf73-434c-a9e4-eec32fd94d20"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RecojoTienda"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.buttonId }}",
                    "rightValue": "PEDIDO_DELIVERY",
                    "id": "2bb7f090-af22-4aa0-89ea-dca23739b915"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Delivery"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7d0a7451-4ace-4a63-9a50-ec76060af71f",
                    "leftValue": "={{ $json.buttonId }}",
                    "rightValue": "CANCELAR",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e71fde1b-ca0d-4aa2-86a9-ee821dfee093",
                    "leftValue": "={{ $json.buttonId }}",
                    "rightValue": "BTN_CONFIRMAR_PEDIDO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ConfirmarPedido"
            }
          ]
        },
        "options": {}
      },
      "id": "e5f2c079-4dd4-4396-99b3-4c57aa3db80b",
      "name": "Switch - Ruta Bot√≥n",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -592,
        672
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $json.telefono }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $json.phoneNumberId }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "={{ 'Aqu√≠ tienes nuestra carta completa: https://wa.me/p/29826327967012417/51921127939' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "0b2f193f-8185-4404-a2a7-1bc2f5b4651f",
      "name": "Set - Mensaje Men√∫",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -304,
        656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "4612d367-e4af-497c-8515-63b4cee4cd4a",
      "name": "HTTP - Enviar Men√∫",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -128,
        656
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $('Set - Datos Bot√≥n WhatsApp').item.json.telefono,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    body: {\n      text: '¬øC√≥mo prefieres tu pedido?'\n    },\n    action: {\n      buttons: [\n        { type: 'reply', reply: { id: 'PEDIDO_RECOJO', title: 'üè™ Recojo en tienda' } },\n        { type: 'reply', reply: { id: 'PEDIDO_DELIVERY', title: 'üõµ Delivery' } }\n      ]\n    }\n  }\n}) }}",
        "options": {}
      },
      "id": "f9cec6ee-9c2c-46c2-aaa1-a1caa6336bc6",
      "name": "HTTP - Preguntar Tipo Entrega",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1296,
        192
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pedidos (cliente_id, estado, tipo_pedido)\nSELECT id, $2, $3\nFROM clientes\nWHERE telefono = $1\nRETURNING id;",
        "options": {
          "queryBatching": "independently",
          "queryReplacement": "={{ $('Set - Datos Bot√≥n WhatsApp').first().json.telefono }},{{ $json.estado }},{{ $json.tipo_entrega }}"
        }
      },
      "id": "35382419-7007-4bca-80c4-8009288fdf01",
      "name": "DB - Crear Pedido",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -48,
        1024
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "tp1",
              "name": "tipo_entrega",
              "type": "string",
              "value": "recojo"
            },
            {
              "id": "tp2",
              "name": "estado",
              "type": "string",
              "value": "PENDIENTE_PEDIDO_RECOJO"
            }
          ]
        },
        "options": {}
      },
      "id": "78cf9257-818c-4fad-9412-e544178d09a6",
      "name": "Set - Tipo Recojo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -304,
        896
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "tp1",
              "name": "tipo_entrega",
              "type": "string",
              "value": "delivery"
            },
            {
              "id": "tp2",
              "name": "estado",
              "type": "string",
              "value": "PENDIENTE_PEDIDO_DELIVERY"
            }
          ]
        },
        "options": {}
      },
      "id": "cddcd8c5-23d4-4556-aed6-f2e910e0e847",
      "name": "Set - Tipo Delivery",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -304,
        1088
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH pedido_actual AS (\n  -- 1. Identificar el pedido activo\n  SELECT p.id\n  FROM pedidos p\n  WHERE p.cliente_id = $1\n    AND p.estado LIKE 'PENDIENTE_PEDIDO_%'\n  ORDER BY p.creado_en DESC\n  LIMIT 1\n),\nactualizar_cabecera AS (\n  -- 2. Actualizar y DEVOLVER los datos nuevos inmediatamente\n  UPDATE pedidos\n  SET\n    accion          = $2,\n    respuesta       = $3,\n    resumen_pedido  = $4,\n    errores         = $5::jsonb,\n    total           = $6,\n    actualizado_en  = now()\n  FROM pedido_actual pa\n  WHERE pedidos.id = pa.id\n  -- IMPORTANTE: Aqu√≠ devolvemos los datos ACTUALIZADOS para usarlos al final\n  RETURNING \n    pedidos.id as pedido_id, \n    pedidos.estado, \n    pedidos.total, \n    pedidos.resumen_pedido, \n    pedidos.errores\n),\nlimpiar_items_anteriores AS (\n  -- 3. Limpieza de items (solo si no hay errores y hay items nuevos)\n  DELETE FROM pedido_items\n  USING pedido_actual pa\n  WHERE pedido_items.pedido_id = pa.id\n    AND jsonb_array_length($5::jsonb) = 0\n    AND jsonb_array_length($7::jsonb) > 0\n),\ninsertar_nuevos_items AS (\n  -- 4. Inserci√≥n de nuevos items\n  INSERT INTO pedido_items (\n    pedido_id, producto_id, producto_nombre, categoria_id,\n    cantidad, variant_id, variant_label, size_code,\n    precio_unitario, subtotal\n  )\n  SELECT\n    pa.id,\n    item->>'producto_id',\n    item->>'producto_nombre',\n    item->>'categoria_id',\n    (item->>'cantidad')::int,\n    item->>'variant_id',\n    item->>'variant_label',\n    item->>'size_code',\n    (item->>'precio_unitario')::numeric,\n    (item->>'subtotal')::numeric\n  FROM pedido_actual pa,\n       jsonb_array_elements($7::jsonb) AS item\n  WHERE jsonb_array_length($5::jsonb) = 0\n  RETURNING pedido_id\n)\n-- 5. SELECT FINAL: Leemos directamente de 'actualizar_cabecera'\nSELECT * FROM actualizar_cabecera;",
        "options": {
          "queryReplacement": "={{ [\n  $node[\"DB - Insertar o Actualizar Cliente\"].json[\"id\"], \n  $json.accion, \n  $json.respuesta, \n  $json.resumen_pedido, \n  $json.sql_errores_json, \n  $json.total, \n  $json.sql_items_json \n] }}"
        }
      },
      "id": "b600b619-c699-4849-bc71-e9d6f820203a",
      "name": "DB - Actualizar Pedido Detalle",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1344,
        592
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "img1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $json.messages[0].from }}"
            },
            {
              "id": "img2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $json.metadata.phone_number_id }}"
            },
            {
              "id": "img3",
              "name": "media_id",
              "type": "string",
              "value": "={{ $json.messages[0].image.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f0750387-d6e8-4a00-821f-c7ea161637f8",
      "name": "Set - Datos Imagen Pago",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1728,
        688
      ]
    },
    {
      "parameters": {
        "jsCode": "// Tomamos el item del input (que viene del IF -> True)\nconst data = $input.first().json;\n\n// 1. Formatear Ubicaci√≥n\nlet ubicacionTexto = 'üè™ Recojo en tienda';\nif (data.ubicacion && data.ubicacion.latitud && data.ubicacion.longitud) {\n  ubicacionTexto = `üìç http://googleusercontent.com/maps.google.com/?q=${data.ubicacion.latitud},${data.ubicacion.longitud}`;\n}\n\n// 2. Construir el mensaje para el staff\nconst mensajeStaff = `üßæ *NUEVO PEDIDO PAGADO (#${data.pedido_finalizado_id})*\n\nüë§ *Cliente:* ${data.nombre_cliente || 'Sin nombre'}\nüì± *Tel√©fono:* ${data.telefono_cliente}\n\nüõí *Detalle:*\n${data.resumen_pedido}\n\n${ubicacionTexto}\n\nüí∞ *Total Pagado:* S/ ${Number(data.total).toFixed(2)}\n\nüìé *Se adjunta comprobante:*`;\n\nreturn {\n  json: {\n    resumenStaff: mensajeStaff,\n    // Recuperamos el media_id del nodo inicial Set, ya que el SQL no lo devuelve\n    comprobante_media_id: $('Set - Datos Imagen Pago').first().json.media_id\n  }\n};"
      },
      "id": "efb60545-22d9-4138-a928-6746a641ea43",
      "name": "Code - Resumen Staff",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        912
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $('Set - Datos Imagen Pago').item.json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $('Set - Datos Imagen Pago').item.json.telefono,\n  type: 'image',\n  image: {\n    id: $json.comprobante_media_id,\n    caption: $json.resumenStaff\n  }\n}) }}",
        "options": {}
      },
      "id": "fc8ae8aa-fb08-4239-b1ba-2769b6c6748f",
      "name": "HTTP - Enviar Resumen Staff",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -816,
        912
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT p.*\nFROM pedidos p\nJOIN clientes c ON p.cliente_id = c.id\nWHERE c.telefono = $1\n  AND p.estado <> 'COMPLETO'\nORDER BY p.creado_en DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ $node[\"Set - Datos Cliente\"].json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -32,
        96
      ],
      "id": "226b0236-8a59-450d-bea4-8f1f9a8aa70a",
      "name": "DB - Obtener Pedido Activo",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"respuesta\": {\n      \"type\": \"string\",\n      \"description\": \"Texto final para el usuario. Debe ser amable y coherente con el estado actual.\"\n    },\n    \"accion\": {\n      \"type\": \"string\",\n      \"description\": \"Determinante para el flujo de n8n. Define el siguiente paso l√≥gico.\",\n      \"enum\": [\n        \"NONE\",\n        \"MOSTRAR_CARTA\",\n        \"INFO_PEDIDO\",\n        \"INFO_DELIVERY\",\n        \"ORDEN_DESCONOCIDA\",\n        \"ESPERAR_UBICACION\",\n        \"ESPERAR_PAGO\",\n        \"SOLICITAR_CONFIRMACION\"\n      ]\n    },\n    \"pedido_parseado\": {\n      \"type\": \"array\",\n      \"description\": \"Array de objetos. Solo se llena si se identifican productos v√°lidos en el mensaje del usuario.\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"producto_id\": {\n            \"type\": \"string\",\n            \"description\": \"ID EXACTO del producto encontrado en el men√∫. Debes aplicar la l√≥gica de emparejamiento sem√°ntico: si el usuario pide ingredientes combinados (X + Y), selecciona el ID del producto combinado correspondiente.\"\n          },\n          \"producto_nombre\": {\n            \"type\": \"string\",\n            \"description\": \"Nombre oficial del producto seg√∫n la carta.\"\n          },\n          \"categoria_id\": {\n            \"type\": \"string\",\n            \"description\": \"ID de la categor√≠a a la que pertenece el producto.\"\n          },\n          \"cantidad\": {\n            \"type\": \"integer\",\n            \"minimum\": 1,\n            \"description\": \"N√∫mero de unidades solicitadas.\"\n          },\n          \"variant_id\": {\n            \"type\": \"string\",\n            \"description\": \"ID de la variante seleccionada. Si el usuario no especifica, usa la variante por defecto del men√∫.\"\n          },\n          \"variant_label\": {\n            \"type\": \"string\",\n            \"description\": \"Nombre visible de la variante (ej: '01 Medium').\"\n          },\n          \"size_code\": {\n            \"type\": \"string\",\n            \"description\": \"C√≥digo t√©cnico del tama√±o (ej: '01_medium').\"\n          },\n          \"precio_unitario\": {\n            \"type\": \"number\",\n            \"description\": \"Precio extra√≠do directamente del men√∫ para esa variante.\"\n          },\n          \"subtotal\": {\n            \"type\": \"number\",\n            \"description\": \"C√°lculo matem√°tico: precio_unitario * cantidad.\"\n          }\n        },\n        \"required\": [\n          \"producto_id\",\n          \"producto_nombre\",\n          \"cantidad\",\n          \"variant_id\",\n          \"size_code\",\n          \"precio_unitario\",\n          \"subtotal\"\n        ]\n      }\n    },\n    \"total\": {\n      \"type\": \"number\",\n      \"description\": \"Suma total monetaria de todos los items del pedido_parseado. Si no hay pedido, es 0.\"\n    },\n    \"resumen_pedido\": {\n      \"type\": \"string\",\n      \"description\": \"Bloque de texto formateado (con saltos de l√≠nea) describiendo el pedido completo y el total. Listo para ser le√≠do por humanos.\"\n    },\n    \"errores\": {\n      \"type\": \"array\",\n      \"description\": \"Lista de strings con problemas detectados (ej: 'Producto X no encontrado', 'Falta elegir tama√±o'). Vac√≠o si todo est√° bien.\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\n    \"respuesta\",\n    \"accion\",\n    \"pedido_parseado\",\n    \"total\",\n    \"resumen_pedido\",\n    \"errores\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        416,
        576
      ],
      "id": "d7b50e57-a7ff-49ad-9d95-bf0e599155a9",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.output.accion }}",
                    "rightValue": "MOSTRAR_CARTA",
                    "id": "02b82466-4afc-4019-a545-071468a1b84c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "MostrarCarta"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.output.accion }}",
                    "rightValue": "INFO_PEDIDO",
                    "id": "8deb3aa2-4abd-427f-8b2e-2a63aa02b2de"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "InfoPedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.output.accion }}",
                    "rightValue": "ORDEN_DESCONOCIDA",
                    "id": "2bb7f090-af22-4aa0-89ea-dca23739b915"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "OrdenDesconocida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3f10c068-442d-4eda-a704-43edb83b9a0f",
                    "leftValue": "={{ $json.output.accion }}",
                    "rightValue": "SOLICITAR_CONFIRMACION",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SolicitarConfirmacion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "15f77105-e7fb-4047-9df5-1fd8c27cde47",
                    "leftValue": "={{ $json.output.accion }}",
                    "rightValue": "ESPERAR_UBICACION",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EsperarUbiacion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ccc2d31a-bc1d-4e91-9fe2-3ecf62cc2d88",
                    "leftValue": "={{ $json.output.accion }}",
                    "rightValue": "ESPERAR_PAGO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EsperarPago"
            }
          ]
        },
        "options": {}
      },
      "id": "37cb0dde-8fab-40fd-b0a0-881c67b3d871",
      "name": "Switch - accion",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        576,
        288
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json[\"estado\"] }}",
                    "rightValue": "PENDIENTE_PEDIDO_DELIVERY",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "85bb4802-4b4d-4c06-82e1-5f2d20780a04"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Delivery"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2423dbe2-06c1-4fdc-8414-d54c13316114",
                    "leftValue": "={{ $json[\"estado\"] }}",
                    "rightValue": "PENDIENTE_PEDIDO_RECOJO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Recojo"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        704,
        1136
      ],
      "id": "31f5d913-dd3f-4dac-9ad1-3dcb92e9bd84",
      "name": "Switch - Tipo Pedido"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.telefono }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.metadata.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=\"‚úÖ ¬°Tu pedido ha sido confirmado para recoger en tienda!\" \n{{ $('Switch - Tipo Pedido').item.json.resumen_pedido }}\nPuedes pagar con efectivo, tarjeta, Yape o Plin al momento de retirar tu orden\n¬°Te esperamos pronto!\""
            }
          ]
        },
        "options": {}
      },
      "id": "d9531adb-6ed3-43e9-92c9-3e2e316dfd69",
      "name": "Set - Mensaje Recojo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        1248
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "c292faba-2a72-4d9a-b0d5-ef8c1d2f8805",
      "name": "HTTP - Enviar Resumen Pedido",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        1248
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "d956b624-5bee-433d-b1b1-d795e4d60dae",
      "name": "HTTP - Enviar Ubi msg",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        800
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "b3b49d6a-d371-43dd-b435-c962ad7d3ed5",
      "name": "HTTP - Enviar Pago msg",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -288,
        320
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sal1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $node[\"Set - Datos Cliente\"].json.telefono }}"
            },
            {
              "id": "sal2",
              "name": "mensaje",
              "type": "string",
              "value": "=¬°Hola, {{ $json.nombre ? $json.nombre + '! ' : '' }}Bienvenido a üåÆ *Tacomiendo*!\\n\\nPreparamos nuestros tacos al momento, con tortillas reci√©n hechas y salsas caseras que pican rico üå∂Ô∏è.\\n\\nUsa los botones de abajo para empezar. ¬°Provecho!"
            }
          ]
        },
        "options": {}
      },
      "id": "35bd5840-aa13-40bd-8b11-3dd374417745",
      "name": "Set - Mensaje Bienvenida",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        48,
        -144
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sal3",
              "name": "telefono",
              "type": "string",
              "value": "={{ $node[\"Set - Datos Cliente\"].json.telefono }}"
            },
            {
              "id": "sal4",
              "name": "mensaje",
              "type": "string",
              "value": "=¬°Hola de nuevo, {{ $node[\"Set - Datos Cliente\"].json.nombre || 'comensal' }}! Soy el robot de üåÆ *Tacomiendo*.\n¬øEn qu√© te puedo ayudar hoy?"
            }
          ]
        },
        "options": {}
      },
      "id": "33b11395-7d02-47a5-b1bd-735aec202470",
      "name": "Set - Mensaje Recurrente",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        704,
        112
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('Set - Datos Bot√≥n WhatsApp').item.json.telefono }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('Set - Datos Bot√≥n WhatsApp').item.json.phoneNumberId }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=¬°Perfecto! Tu pedido para delivery es:\n\n{{ $('Switch - Tipo Pedido').item.json.resumen_pedido }}\n\nPara coordinar la entrega, por favor, responde a este mensaje con:\n\n- Tu nombre completo.\n- Una referencia para el repartidor (ej: \"casa azul de dos pisos\").\n- Un tel√©fono de contacto adicional (opcional).`"
            }
          ]
        },
        "options": {}
      },
      "id": "69215895-dd20-40ad-bab0-19bab601555b",
      "name": "Set - Mensaje Pedir Datos Delivery",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        1008
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5391bb13-2ef3-4d7d-b51a-29f1bf83aca2",
              "name": "telefono",
              "value": "={{ $('Set - Datos Cliente').item.json.telefono }}",
              "type": "string"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.metadata.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=Gracias. Ahora, por favor, comparte tu ubicaci√≥n exacta.\nToca el icono del clip üìé en WhatsApp, selecciona \"Ubicaci√≥n\" y luego pulsa en \"Enviar mi ubicaci√≥n actual\"."
            }
          ]
        },
        "options": {}
      },
      "id": "ad347907-02b7-49f0-909d-d012638f3f89",
      "name": "Set - Mensaje Pedir Ubicaci√≥n",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1136,
        800
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=¬°Ya casi terminamos! Solo falta el √∫ltimo paso.\nRealiza el pago total por *Yape* o *Plin* al n√∫mero *987654321* y env√≠ame la *captura de pantalla completa* del comprobante para confirmar tu pedido."
            }
          ]
        },
        "options": {}
      },
      "id": "35bcf41d-35b9-4750-8957-634dc9642a88",
      "name": "Set - Mensaje Instrucciones de Pago",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -448,
        208
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH inserted AS (\n  INSERT INTO clientes (telefono, nombre, primer_mensaje, metadatos)\n  VALUES ($1, $2, $3, $4::jsonb)\n  ON CONFLICT (telefono) DO NOTHING\n  RETURNING id, telefono\n),\nresult AS (\n  -- Si se insert√≥, devolvemos ese registro y marcamos que es nuevo\n  SELECT id, TRUE AS es_primer_mensaje\n  FROM inserted\n\n  UNION ALL\n\n  -- Si NO se insert√≥ (ya exist√≠a), buscamos el cliente y marcamos false\n  SELECT c.id, FALSE AS es_primer_mensaje\n  FROM clientes c\n  WHERE c.telefono = $1\n    AND NOT EXISTS (SELECT 1 FROM inserted)\n)\nSELECT *\nFROM result\nLIMIT 1;\n",
        "options": {
          "queryBatching": "independently",
          "queryReplacement": "={{ [ $json.telefono, $json.nombre, $json.primerMensaje, $json.metadata ] }}"
        }
      },
      "id": "a40cd116-6f04-4142-8e9c-731da3751973",
      "name": "DB - Insertar o Actualizar Cliente",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1000,
      "position": [
        -512,
        0
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos\nSET estado = 'PENDIENTE_DATOS_DELIVERY'\nWHERE id = {{ $json.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        928,
        1008
      ],
      "id": "39ee5afa-3ead-4f36-a362-08415ab2a3e4",
      "name": "DB - Actualizar Estado a PENDIENTE_DATOS_DELIVERY",
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos\nSET estado = 'COMPLETO'\nWHERE id = {{ $json.pedido_id }};",
        "options": {
          "queryBatching": "independently",
          "queryReplacement": ""
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        928,
        1248
      ],
      "id": "e36045c8-bb95-4fad-8758-c7744bfc2032",
      "name": "DB - Actualizar Estado a COMPLETO",
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos\nSET estado = 'PENDIENTE_UBICACION'\nWHERE id = {{ $('DB - Obtener Pedido Activo').item.json.id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        944,
        800
      ],
      "id": "6dd14040-f070-4c03-84ad-2e38c4393f56",
      "name": "DB - Actualizar Estado a PENDIENTE_UBICACION",
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH pedido_pendiente AS (\n    -- 1. Buscamos el pedido ACTIVO que est√° esperando pago\n    SELECT p.id\n    FROM pedidos p\n    JOIN clientes c ON p.cliente_id = c.id\n    WHERE c.telefono = $1 \n      AND p.estado = 'PENDIENTE_PAGO' -- CR√çTICO: Solo si espera pago\n    ORDER BY p.creado_en DESC\n    LIMIT 1\n)\nUPDATE pedidos\nSET \n    -- Solo actualizamos los metadatos con la foto, NO el estado\n    metadatos = COALESCE(metadatos, '{}'::jsonb) || jsonb_build_object('comprobante_media_id', $2),\n    actualizado_en = now()\nFROM pedido_pendiente\nWHERE pedidos.id = pedido_pendiente.id\nRETURNING pedidos.id as pedido_encontrado_id;",
        "options": {
          "queryBatching": "independently",
          "queryReplacement": "={{ $json.telefono }}, {{ $json.media_id }}"
        }
      },
      "id": "4a758010-3919-4e0e-b74f-afe94c2d9716",
      "name": "DB - Guardar Comprobante y Finalizar Pedido",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1520,
        688
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9bb2e2df-cd2d-46f5-9e14-38e365784779",
              "leftValue": "={{$json.es_primer_mensaje}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -304,
        0
      ],
      "id": "26fa9fad-b09f-4313-8416-9d65029ec0ad",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "95bc4f53-4dfd-4e34-8cf2-2966e0c07794",
      "name": "HTTP - Preguntar Pedido",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        368,
        1024
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('Set - Datos Bot√≥n WhatsApp').item.json.telefono }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('Set - Datos Bot√≥n WhatsApp').item.json.phoneNumberId }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=Por favor env√≠ame el detalle completo de tu pedido en un solo mensaje (productos y cantidades)."
            }
          ]
        },
        "options": {}
      },
      "id": "180eb331-0656-4d4f-b79c-d47d477f32d6",
      "name": "Set - Mensaje Pedir Pedido",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        160,
        1024
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.telefono }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.metadata.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "={{ $json.output.respuesta }}"
            },
            {
              "id": "07ea538c-d6a8-46a5-acea-dd92c5da160e",
              "name": "output.accion",
              "value": "={{ $json.output.accion }}",
              "type": "string"
            },
            {
              "id": "43c81048-900e-498d-af96-ed0aec4cfa8d",
              "name": "output.total",
              "value": "={{ $json.output.total }}",
              "type": "number"
            },
            {
              "id": "f90169b5-aa63-4d80-97ea-a986bd560d28",
              "name": "output.resumen_pedido",
              "value": "={{ $json.output.resumen_pedido }}",
              "type": "string"
            },
            {
              "id": "dd977d2e-73f2-4a22-8908-526e6e886520",
              "name": "output.errores",
              "value": "={{ $json.output.errores }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "d92cb16d-2e9b-4c23-9513-cc65340cc35f",
      "name": "Set - Solicitar Informacion",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        944,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5fc85b4b-029b-4a05-95eb-c8431a08e520",
              "leftValue": "={{ $json.output.errores }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1104,
        176
      ],
      "id": "8405107c-a5b4-4b86-9885-a2c7253f858e",
      "name": "If - Hay Errores"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "45d32d06-8b97-4ef0-9e4a-3e7a022cb10d",
      "name": "HTTP - Mensaje Solicitar Informacion Delivery",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        1008
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}\n\n",
        "options": {}
      },
      "id": "d1dc3236-da0b-4084-a6df-9ee6ec71d2f4",
      "name": "HTTP - Mensaje Error",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1296,
        -32
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1) Obtener y parsear la carta (con soporte Base64 robusto)\nconst inputItem = $input.first();\nconst inputJson = inputItem.json;\nconst base64Content = inputJson.content || (inputJson.data && inputJson.data.content) || inputJson.data;\n\nlet cartaJson;\ntry {\n  if (base64Content && typeof base64Content === 'string') {\n      const asciiContent = Buffer.from(base64Content, 'base64').toString('utf-8');\n      cartaJson = JSON.parse(asciiContent);\n  } else {\n      cartaJson = typeof inputJson.data === 'object' ? inputJson.data : {};\n  }\n} catch (e) {\n  throw new Error('Error cr√≠tico parseando carta.json: ' + e.message);\n}\n\nconst categories = (cartaJson.menu && cartaJson.menu.categories) || [];\nconst currencySymbol = (cartaJson.currency && cartaJson.currency.symbol) ? cartaJson.currency.symbol : 'S/';\n\n// 2) Obtener el output del AI Agent\nconst aiOutput = $('AI Agent').first().json.output || {};\nconst pedidoLlm = Array.isArray(aiOutput.pedido_parseado) ? aiOutput.pedido_parseado : [];\nlet errores = Array.isArray(aiOutput.errores) ? [...aiOutput.errores] : [];\nconst itemsValidados = [];\n\n// Helper: B√∫squeda de variante\nfunction buscarVariant(productoId, variantId) {\n  for (const cat of categories) {\n    const items = cat.items || [];\n    for (const item of items) {\n      if (item.id === productoId) {\n        const variants = item.variants || [];\n        for (const v of variants) {\n          if (v.id === variantId || v.id === variantId.trim()) {\n            return {\n              categoria_id: cat.id,\n              producto_nombre: item.name,\n              variant_label: v.label,\n              size_code: v.size_code,\n              precio: Number(v.price)\n            };\n          }\n        }\n      }\n    }\n  }\n  return null;\n}\n\n// 3) Validar y construir items\npedidoLlm.forEach((linea, index) => {\n  const lineaIdx = index + 1;\n  const productoId = linea?.producto_id;\n  const variantId = linea?.variant_id;\n  let cantidad = Number(linea?.cantidad);\n\n  if (!productoId || !variantId) {\n    errores.push(`L√≠nea ${lineaIdx}: Faltan datos.`);\n    return;\n  }\n  const variantInfo = buscarVariant(productoId, variantId);\n  if (!variantInfo) {\n    errores.push(`L√≠nea ${lineaIdx}: Producto no encontrado en carta.`);\n    return;\n  }\n\n  const precioUnitario = variantInfo.precio;\n  const subtotal = Number((precioUnitario * cantidad).toFixed(2));\n\n  itemsValidados.push({\n    producto_id: productoId,\n    producto_nombre: variantInfo.producto_nombre,\n    categoria_id: variantInfo.categoria_id,\n    cantidad,\n    variant_id: variantId,\n    variant_label: variantInfo.variant_label,\n    size_code: variantInfo.size_code,\n    precio_unitario: precioUnitario,\n    subtotal\n  });\n});\n\n// 4) Calcular totales\nlet totalCalculado = Number(itemsValidados.reduce((acc, it) => acc + it.subtotal, 0).toFixed(2));\n\nlet resumen = '';\nif (itemsValidados.length > 0) {\n  const lineasResumen = itemsValidados.map((it) =>\n    `‚Ä¢ ${it.cantidad}x ${it.producto_nombre} (${it.variant_label})`\n  );\n  resumen = lineasResumen.join('\\n') + `\\n\\n*Total: ${currencySymbol} ${totalCalculado.toFixed(2)}*`;\n}\n\n// 5) SALIDA PREPARADA PARA SQL (Strings Listos)\n// Convertimos los objetos complejos a String aqu√≠ para evitar errores en el nodo de Postgres\nreturn {\n  json: {\n    accion: aiOutput.accion || 'ORDEN_CONFIRMADA',\n    respuesta: aiOutput.respuesta,\n    resumen_pedido: resumen,\n    total: totalCalculado,\n    \n    // PREPARADOS PARA SQL:\n    sql_errores_json: JSON.stringify(errores),\n    sql_items_json: JSON.stringify(itemsValidados)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        592
      ],
      "id": "e4572c8f-3cf8-4bd8-9c79-f2438ced1a35",
      "name": "Validar y armar pedido final"
    },
    {
      "parameters": {
        "resource": "file",
        "operation": "get",
        "owner": {
          "__rl": true,
          "value": "marcksdbgg",
          "mode": "name"
        },
        "repository": {
          "__rl": true,
          "value": "m8-apps",
          "mode": "name"
        },
        "filePath": "Restaurant/resources/carta.json",
        "asBinaryProperty": false,
        "additionalParameters": {}
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "position": [
        944,
        592
      ],
      "id": "362e5c5a-ddc7-4ea0-9906-362062109633",
      "name": "GH - Obtener Carta",
      "webhookId": "9d4e9dca-000e-4173-84ec-3969698bcae7",
      "credentials": {
        "githubApi": {
          "id": "zv1NwM18dIrEb3IE",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.telefono }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('Set - Datos Cliente').item.json.metadata.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "={{ $json.output.respuesta }}"
            },
            {
              "id": "07ea538c-d6a8-46a5-acea-dd92c5da160e",
              "name": "output.accion",
              "value": "={{ $json.output.accion }}",
              "type": "string"
            },
            {
              "id": "43c81048-900e-498d-af96-ed0aec4cfa8d",
              "name": "output.total",
              "value": "={{ $json.output.total }}",
              "type": "number"
            },
            {
              "id": "f90169b5-aa63-4d80-97ea-a986bd560d28",
              "name": "output.resumen_pedido",
              "value": "={{ $json.output.resumen_pedido }}",
              "type": "string"
            },
            {
              "id": "dd977d2e-73f2-4a22-8908-526e6e886520",
              "name": "output.errores",
              "value": "={{ $json.output.errores }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "b4cda385-f123-458d-ac7e-d21c8bccb4ef",
      "name": "Set - Obtener mensaje",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        944,
        400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    body: {\n      text: $('AI Agent').item.json.output.respuesta || '¬øQu√© deseas hacer con tu pedido actual?'\n    },\n    action: {\n      buttons: [\n        {\n          type: 'reply',\n          reply: {\n            id: 'CANCELAR',\n            title: '‚ùå Cancelar pedido'\n          }\n        }\n      ]\n    }\n  }\n}) }}",
        "options": {}
      },
      "id": "280b4274-e84c-46dc-870a-a64a91c1b1c2",
      "name": "HTTP - Cancelar pedido",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1136,
        400
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM pedidos\nUSING clientes\nWHERE pedidos.cliente_id = clientes.id\n  AND clientes.telefono = $1\n  AND pedidos.estado <> 'COMPLETO';",
        "options": {
          "queryReplacement": "={{ $('Set - Datos Bot√≥n WhatsApp').first().json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -304,
        1264
      ],
      "id": "f9772d16-3014-4f53-beea-c158c97414d7",
      "name": "Eliminar Pedido",
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $('Set - Datos Bot√≥n WhatsApp').first().json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $('Set - Datos Bot√≥n WhatsApp').first().json.telefono,\n  type: 'text',\n  text: { body: \"‚úÖ Tu pedido ha sido cancelado y eliminado correctamente.\\n\\nSi se te antoja algo m√°s tarde, solo escribe *Hola* para comenzar de nuevo. üëã\" }\n}) }}",
        "options": {}
      },
      "id": "da41f3ad-bb04-4481-b377-7896dbbaccf8",
      "name": "HTTP - Eliminacion Exitosa",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -128,
        1264
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "file",
        "operation": "get",
        "owner": {
          "__rl": true,
          "value": "marcksdbgg",
          "mode": "name"
        },
        "repository": {
          "__rl": true,
          "value": "m8-apps",
          "mode": "name"
        },
        "filePath": "Restaurant/resources/carta.json",
        "asBinaryProperty": false,
        "additionalParameters": {}
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "position": [
        176,
        96
      ],
      "id": "01c47f5b-22bb-4857-8065-1a429f03e357",
      "name": "GH - Obtener Carta1",
      "webhookId": "9d4e9dca-000e-4173-84ec-3969698bcae7",
      "credentials": {
        "githubApi": {
          "id": "zv1NwM18dIrEb3IE",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Nodo Code despu√©s de GitHub y antes de Preparar Contexto\nconst item = $input.first().json;\n\n// La API de GitHub devuelve el contenido en base64 en el campo 'content'\n// A veces viene en 'data.content' dependiendo de la versi√≥n del nodo\nconst base64Content = item.data ? item.data.content : item.content;\n\nif (base64Content) {\n  const asciiContent = Buffer.from(base64Content, 'base64').toString('utf-8');\n  const menuJson = JSON.parse(asciiContent);\n  \n  return {\n    json: {\n      menu_limpio: menuJson.menu // Pasamos solo la parte del men√∫\n    }\n  };\n}\n\nreturn { json: { menu_limpio: [] } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        96
      ],
      "id": "fa3166a7-b154-45d6-87d8-3d4977ca39c6",
      "name": "JS - Parsear Carta"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener datos del usuario (Cliente)\nconst clienteNode = $('Set - Datos Cliente').first();\nconst originalMsg = clienteNode.json.primerMensaje || $('WhatsApp Trigger').first().json.messages[0].text.body;\nconst phone = clienteNode.json.telefono;\n\n// 2. Obtener resultado de la Base de Datos\n// IMPORTANTE: Lo buscamos por nombre espec√≠fico porque el input directo viene del JS de la carta\nlet orderState = 'NONE';\nlet prevSummary = '';\n\ntry {\n  // Buscamos el nodo DB expl√≠citamente\n  const dbNode = $('DB - Obtener Pedido Activo').first();\n  if (dbNode && dbNode.json && dbNode.json.id) {\n      const dbResult = dbNode.json;\n      orderState = dbResult.estado || 'NONE';\n      prevSummary = dbResult.resumen_pedido || '';\n  }\n} catch (error) {\n  // Si falla o no hay pedido previo, se queda en NONE\n  console.log('No se encontraron datos previos de DB o el nodo no se ejecut√≥ a√∫n');\n}\n\n// 3. Recuperar el men√∫ limpio del nodo JS (Corregido el nombre)\n// AQU√ç ESTABA EL ERROR: El nombre debe coincidir exactamente con el nodo en el lienzo\nlet menuData = [];\ntry {\n    // Usamos el nombre exacto que tienes en la imagen: \"JS - Parsear Carta\"\n    menuData = $('JS - Parsear Carta').first().json.menu_limpio || [];\n} catch (e) {\n    console.log('Error recuperando el men√∫ del nodo JS - Parsear Carta');\n}\n\n// 4. Construimos el objeto para el AI Agent\nconst aiInputObject = {\n  user_message: originalMsg,\n  order_state: orderState,\n  phone: phone,\n  previous_summary: prevSummary,\n  menu: menuData\n};\n\n// 5. Retorno final\nreturn {\n  json: {\n    ai_prompt_input: JSON.stringify(aiInputObject)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        304
      ],
      "id": "7c1eded2-50ff-45c3-8ef9-1c20081bf5fa",
      "name": "JS - Preparar Contexto"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH pedido_pendiente AS (\n    -- 1. Buscamos si existe un pedido EXACTO esperando ubicaci√≥n para este tel√©fono\n    SELECT p.id\n    FROM pedidos p\n    JOIN clientes c ON p.cliente_id = c.id\n    WHERE c.telefono = $1 \n      AND p.estado = 'PENDIENTE_UBICACION'\n    LIMIT 1\n)\nUPDATE pedidos\nSET \n    ubicacion = jsonb_build_object(\n        'latitud', $2::numeric,\n        'longitud', $3::numeric\n    ),\n    estado = 'PENDIENTE_PAGO',\n    actualizado_en = now()\nFROM pedido_pendiente\nWHERE pedidos.id = pedido_pendiente.id\nRETURNING pedidos.id as pedido_actualizado_id;",
        "options": {
          "queryBatching": "independently",
          "queryReplacement": "={{ [\n  $json.messages[0].from, \n  $json.messages[0].location.latitude, \n  $json.messages[0].location.longitude \n] }}"
        }
      },
      "id": "582e2c8b-03ef-49e9-a750-e72bd448ad30",
      "name": "DB - Procesar Ubicaci√≥n",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -800,
        384
      ],
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "14e57485-d7f7-4268-a83f-5c8b970901ce",
              "leftValue": "={{ $json.pedido_actualizado_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -672,
        240
      ],
      "id": "87666a0e-726e-4222-9789-aa2de5019f96",
      "name": "If - Pedido Encontrado"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=He recibido una ubicaci√≥n, pero no tengo ning√∫n pedido abierto esperando datos de entrega en este momento. Por favor, escribe 'Hola' si quieres iniciar un pedido nuevo."
            }
          ]
        },
        "options": {}
      },
      "id": "3b586a8c-dbfa-4d56-ad7e-9c8c921ea0f6",
      "name": "Set - Mensaje Ubicacion Inesperada",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -448,
        416
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e20a2ab0-c716-4196-b820-ec088ba9f546",
              "leftValue": "={{ $json.pedido_encontrado_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1344,
        688
      ],
      "id": "b8ec1700-35eb-4f98-82a4-96d240b3f775",
      "name": "If - Pedido Pagado Encontrado"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "m1",
              "name": "telefono",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}"
            },
            {
              "id": "m2",
              "name": "phoneNumberId",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}"
            },
            {
              "id": "m3",
              "name": "mensaje",
              "type": "string",
              "value": "=He recibido una imagen üì∑, pero no tengo ning√∫n pedido pendiente de pago en este momento. Si quieres hacer un nuevo pedido, por favor escribe 'Hola'."
            }
          ]
        },
        "options": {}
      },
      "id": "7f0f0734-798c-484c-ad7b-fb14b44af9ba",
      "name": "Set - Mensaje Imagen Inesperada",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1152,
        704
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  messaging_product: 'whatsapp',\n  to: $json.telefono,\n  type: 'text',\n  text: { body: $json.mensaje }\n}) }}",
        "options": {}
      },
      "id": "e909bf29-660c-4da6-a915-306290955012",
      "name": "HTTP - Mensaje error",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -976,
        704
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $('Set - Datos Cliente').item.json.phoneNumberId }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\nJSON.stringify({\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": $('Set - Datos Cliente').item.json.telefono,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"üìù *Resumen de tu pedido:*\\n\\n\" + $json.resumen_pedido + \"\\n\\nüí∞ *Total a pagar:* S/ \" + $json.total + \"\\n\\n¬øEst√° todo correcto? üëá\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"BTN_CONFIRMAR_PEDIDO\",\n            \"title\": \"‚úÖ S√≠, Confirmar\"\n          }\n        }\n      ]\n    }\n  }\n})\n}}",
        "options": {}
      },
      "id": "955caf7a-d8e0-4d53-af16-7139d3663755",
      "name": "HTTP - Bot√≥n Confirmaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1600,
        592
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT p.*\nFROM pedidos p\nJOIN clientes c ON p.cliente_id = c.id\nWHERE c.telefono = $1\n  AND p.estado <> 'COMPLETO'\nORDER BY p.creado_en DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ $('Set - Datos Bot√≥n WhatsApp').item.json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        800
      ],
      "id": "197066cc-8772-48f3-b3a4-e75624aacc92",
      "name": "DB - Obtener Pedido Activo1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    id AS pago_id,\n    monto,\n    remitente,\n    codigo_operacion,\n    estado\nFROM pagos_recibidos\nWHERE \n    estado = 'PENDIENTE'\n    AND monto = $1\n    AND (\n        codigo_operacion = $3\n        OR\n        mensaje_original LIKE '%' || $2 || '%'\n    )\n    AND fecha_recepcion >= (NOW() - INTERVAL '3 days')\nORDER BY fecha_recepcion DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ [\n  parseFloat($json.output.monto || 0),\n  $json.output.codigo_seguridad || '',\n  $json.output.numero_operacion || ''\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1584,
        896
      ],
      "id": "bd633f90-70ab-4b85-a5ea-31fa714562e2",
      "name": "DB - Buscar Conciliaci√≥n",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pedido finalizado en DB\nconst pedidoDb = $('DB - Guardar Comprobante y Finalizar Pedido').first().json || {};\n\n// Resultado del OCR\nconst ocrNode = $('JS - OCR Parseo').first().json || {};\nconst ocr = ocrNode.output || ocrNode || {};\n\n// Datos del WhatsApp Trigger (cliente)\nconst waRaw = $('WhatsApp Trigger').first().json || {};\n// El trigger puede venir como array o como objeto plano\nconst waData = Array.isArray(waRaw) ? waRaw[0] : waRaw;\n\nconst contact = (waData.contacts && waData.contacts[0]) || {};\nconst profile = contact.profile || {};\nconst firstMsg = (waData.messages && waData.messages[0]) || {};\n\nconst cliente = {\n  nombre: profile.name || 'Desconocido',\n  telefono: contact.wa_id || firstMsg.from || ''\n};\n\n// Resultado de la b√∫squeda en banco (DB - Buscar Conciliaci√≥n => input del nodo)\nconst itemsPago = $input.all();\nconst pagoEncontrado =\n  (itemsPago.length > 0 && Object.keys(itemsPago[0].json).length > 0)\n    ? itemsPago[0].json\n    : null;\n\n// Constantes\nconst ADMIN_PHONE = '51987654321';\nconst TOLERANCIA = 0.50;\n\n// Objeto base de respuesta\nconst resultado = {\n  aprobado: false,\n  motivo_tecnico: '',\n  mensaje_usuario: '',\n  mensaje_admin: '',\n  admin_phone: ADMIN_PHONE,\n  pedido_id: pedidoDb.pedido_finalizado_id || 'N/A',\n  monto_voucher: parseFloat(ocr.monto || 0),\n  monto_pedido: parseFloat(pedidoDb.total || 0),\n  codigo_voucher: ocr.codigo_seguridad || 'ILEGIBLE'\n};\n\n// 1) Sin ID de pedido\nif (!resultado.pedido_id || resultado.pedido_id === 'N/A') {\n  resultado.motivo_tecnico = 'ERROR_SISTEMA_SIN_PEDIDO';\n  resultado.mensaje_usuario = 'Hubo un error identificando tu pedido. Un asesor te contactar√°.';\n  resultado.mensaje_admin =\n    `üö® *ERROR CR√çTICO SISTEMA*\\n\\n` +\n    `No se recuper√≥ el ID del pedido finalizado.\\n` +\n    `Cliente: ${cliente.nombre || 'Desconocido'} (${cliente.telefono || 's/tel√©fono'})\\n` +\n    `Monto OCR: ${resultado.monto_voucher}`;\n  return { json: resultado };\n}\n\n// 2) Imagen no es voucher\nif (!ocr.es_voucher_pagado) {\n  resultado.motivo_tecnico = 'IMAGEN_NO_VALIDA';\n  resultado.mensaje_usuario =\n    'No pudimos leer los datos de tu comprobante. Por favor, aseg√∫rate de enviar la captura completa y n√≠tida.';\n  resultado.mensaje_admin =\n    `‚ö†Ô∏è *ERROR OCR (NO ES VOUCHER)*\\n` +\n    `Pedido #${resultado.pedido_id}\\n` +\n    `Cliente: ${cliente.nombre || 'Desconocido'}\\n` +\n    `El cliente envi√≥ una imagen que no parece un voucher v√°lido.`;\n  return { json: resultado };\n}\n\n// 3) No hay pago encontrado en el webhook Yape/Plin\nif (!pagoEncontrado) {\n  resultado.motivo_tecnico = 'PAGO_NO_ENCONTRADO_EN_BANCO';\n  resultado.mensaje_usuario =\n    'Hemos recibido tu comprobante. üßæ\\n\\n' +\n    'Nuestro sistema bancario a√∫n no reporta el movimiento autom√°ticamente.\\n\\n' +\n    'üëÆ‚Äç‚ôÇÔ∏è *Un asesor revisar√° tu pago manualmente en breves minutos.*';\n  resultado.mensaje_admin =\n    `üö® *REVISI√ìN MANUAL REQUERIDA*\\n\\n` +\n    `Pedido: #${resultado.pedido_id}\\n` +\n    `Cliente: ${cliente.nombre || 'Desconocido'} (${cliente.telefono || 's/tel√©fono'})\\n\\n` +\n    `Datos Voucher (OCR):\\n` +\n    `- Monto: S/ ${resultado.monto_voucher}\\n` +\n    `- C√≥digo: ${resultado.codigo_voucher}\\n\\n` +\n    `‚ùå *Error:* No se encontr√≥ coincidencia en la base de datos (Webhook Yape/Plin).`;\n  return { json: resultado };\n}\n\n// 4) Comparaci√≥n de montos\nconst montoBanco = parseFloat(pagoEncontrado.monto);\nconst diferencia = montoBanco - resultado.monto_pedido;\n\nif (Math.abs(diferencia) <= TOLERANCIA) {\n  // Conciliaci√≥n OK\n  resultado.aprobado = true;\n  resultado.motivo_tecnico = 'CONCILIACION_EXITOSA';\n  resultado.pago_id = pagoEncontrado.pago_id;\n  resultado.mensaje_admin =\n    `‚úÖ *PAGO CONCILIADO*\\n` +\n    `Pedido #${resultado.pedido_id}\\n` +\n    `Monto: S/ ${montoBanco}`;\n} else {\n  // Montos distintos\n  resultado.aprobado = false;\n\n  if (diferencia < 0) {\n    // Pag√≥ menos\n    resultado.motivo_tecnico = 'MONTO_INSUFICIENTE';\n    resultado.mensaje_usuario =\n      `Hemos detectado tu pago, pero el monto (S/ ${montoBanco}) ` +\n      `es menor al total del pedido (S/ ${resultado.monto_pedido}).\\n\\n` +\n      `Por favor completa el saldo restante o espera a un asesor.`;\n    resultado.mensaje_admin =\n      `‚ö†Ô∏è *PAGO INCOMPLETO*\\n` +\n      `Pedido #${resultado.pedido_id}\\n` +\n      `Cliente: ${cliente.nombre || 'Desconocido'}\\n` +\n      `Esperado: ${resultado.monto_pedido}\\n` +\n      `Recibido: ${montoBanco}\\n` +\n      `Diferencia: ${diferencia.toFixed(2)}`;\n  } else {\n    // Pag√≥ de m√°s\n    resultado.motivo_tecnico = 'MONTO_EXCEDENTE';\n    resultado.mensaje_usuario =\n      'Recibimos tu pago por un monto mayor al pedido. Un asesor validar√° el cambio.';\n    resultado.mensaje_admin =\n      `‚ö†Ô∏è *PAGO MAYOR AL TOTAL*\\n` +\n      `Pedido #${resultado.pedido_id}\\n` +\n      `Cliente: ${cliente.nombre || 'Desconocido'}\\n` +\n      `Recibido: ${montoBanco}\\n` +\n      `Esperado: ${resultado.monto_pedido}`;\n  }\n}\n\nreturn { json: resultado };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        1136
      ],
      "id": "a164e9eb-c4e1-487d-bbdb-d044d63dcafe",
      "name": "JS - Validaci√≥n Cruzada"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH actualizar_pedido AS (\n    UPDATE pedidos\n    SET \n        estado = 'COMPLETO',\n        actualizado_en = now()\n    WHERE id = $1\n    RETURNING \n        id,\n        cliente_id,\n        resumen_pedido,\n        total,\n        ubicacion\n),\nactualizar_pago AS (\n    UPDATE pagos_recibidos\n    SET \n        estado = 'ASIGNADO',\n        pedido_id = $1,\n        actualizado_en = now()\n    WHERE id = $2\n    RETURNING \n        id    AS pago_id,\n        monto,\n        remitente\n),\ndatos_cliente AS (\n    SELECT \n        c.id,\n        c.nombre,\n        c.telefono\n    FROM clientes c\n    JOIN actualizar_pedido ap ON c.id = ap.cliente_id\n)\nSELECT\n    ap.id          AS pedido_finalizado_id,\n    dc.nombre      AS nombre_cliente,\n    dc.telefono    AS telefono_cliente,\n    ap.resumen_pedido,\n    ap.total,\n    ap.ubicacion,\n    pg.pago_id,\n    pg.monto       AS monto_pagado,\n    pg.remitente\nFROM actualizar_pedido ap\nJOIN datos_cliente dc ON dc.id = ap.cliente_id\nLEFT JOIN actualizar_pago pg ON true;\n",
        "options": {
          "queryReplacement": "={{ [ $json.pedido_id, $json.pago_id ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1200,
        912
      ],
      "id": "e97710fc-8051-481d-af16-02fb3d33e387",
      "name": "DB - Validar pedido completo y completar",
      "credentials": {
        "postgres": {
          "id": "EuEbLjm0Yx9snHhs",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('WhatsApp Trigger').item.json.messages[0].image.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -1984,
        896
      ],
      "id": "9815e894-7190-4897-a91e-fbebcedfcb2c",
      "name": "Download media",
      "webhookId": "e9a42855-0f1f-4c1d-987a-4fe79d4f4ee0",
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.0-flash-lite-001",
          "mode": "list",
          "cachedResultName": "models/gemini-2.0-flash-lite-001"
        },
        "text": "Act√∫a como un API de OCR estricto para comprobantes de pago 'Yape'. Tu √öNICA funci√≥n es extraer datos visuales y devolver un objeto JSON.\n\nINSTRUCCIONES DE EXTRACCI√ìN:\n1. monto: Busca el n√∫mero grande principal. Devu√©lvelo como N√öMERO (float), sin el s√≠mbolo 'S/'. (Ejemplo: 51.00).\n2. codigo_seguridad: ATENCI√ìN: Son los 3 d√≠gitos grandes que aparecen en recuadros separados o espaciados (ej: \"7 6 2\"). √önelos y devu√©lvelo como texto (Ejemplo: \"762\"). SIEMPRE EXTRAE ESTO.\n3. numero_operacion: El n√∫mero largo al pie del recibo (Ejemplo: \"06486762\").\n\nSi la imagen no es un Yape v√°lido, devuelve un JSON con valores null.\n\nResponde √öNICAMENTE con el JSON crudo, sin bloques de c√≥digo markdown (```json) ni texto adicional.",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -2016,
        1136
      ],
      "id": "d73dcc75-b22e-4e42-a497-7e176f32e1dc",
      "name": "Analyze an image",
      "credentials": {
        "googlePalmApi": {
          "id": "yeqbpZlp9wKGsLSg",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "id": "2822cb8c-ca01-4e21-9126-02e6a2a971c8",
      "name": "HTTP - Download Image",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1808,
        896
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        },
        "httpHeaderAuth": {
          "id": "L3XHwLYJUc8ogGTJ",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener el primer item del input (Output de Gemini)\nconst item = $input.first();\nconst geminiData = item.json;\n\n// Definir estructura por defecto en caso de fallo\nlet result = {\n  monto: 0,\n  codigo_seguridad: null,\n  numero_operacion: null,\n  es_voucher_pagado: false,\n  raw_text: \"\"\n};\n\ntry {\n  // 1. Extraer el texto de la respuesta de Gemini\n  // La estructura es content.parts[0].text\n  if (geminiData.content && geminiData.content.parts && geminiData.content.parts[0]) {\n    const textPart = geminiData.content.parts[0].text;\n    result.raw_text = textPart;\n\n    // 2. Limpieza robusta del Markdown (```json ... ```)\n    // Usamos una expresi√≥n regular para capturar solo lo que est√° entre llaves {}\n    const jsonMatch = textPart.match(/\\{[\\s\\S]*\\}/);\n\n    if (jsonMatch) {\n      // 3. Parsear el string a Objeto JSON\n      const parsedObj = JSON.parse(jsonMatch[0]);\n\n      // 4. Asignar y validar tipos\n      result.monto = typeof parsedObj.monto === 'number' ? parsedObj.monto : parseFloat(parsedObj.monto || 0);\n      result.codigo_seguridad = parsedObj.codigo_seguridad ? String(parsedObj.codigo_seguridad).trim() : null;\n      result.numero_operacion = parsedObj.numero_operacion ? String(parsedObj.numero_operacion).trim() : null;\n      \n      // Si el modelo no devolvi√≥ 'es_voucher_pagado', lo inferimos:\n      // Si hay monto y (c√≥digo seguridad O n√∫mero operaci√≥n), asumimos que es v√°lido.\n      if (parsedObj.es_voucher_pagado !== undefined) {\n        result.es_voucher_pagado = parsedObj.es_voucher_pagado;\n      } else {\n        result.es_voucher_pagado = (result.monto > 0 && (result.codigo_seguridad || result.numero_operacion));\n      }\n    }\n  }\n} catch (error) {\n  // Si falla el parseo, dejamos los valores por defecto y logueamos el error\n  console.log(\"Error parseando respuesta de Gemini:\", error.message);\n  result.error_parseo = error.message;\n}\n\n// 5. Retornar estructura \"output\" para compatibilidad con tus nodos siguientes\nreturn {\n  json: {\n    output: result\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1824,
        1136
      ],
      "id": "cc38d8bd-5150-4c37-8498-93dff5263277",
      "name": "JS - OCR Parseo"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "gs_date",
              "name": "Fecha",
              "type": "string",
              "value": "={{ $now.setZone('America/Lima').toFormat('yyyy-MM-dd') }}"
            },
            {
              "id": "gs_time",
              "name": "Hora",
              "type": "string",
              "value": "={{ $now.setZone('America/Lima').toFormat('HH:mm:ss') }}"
            },
            {
              "id": "gs_month",
              "name": "Mes",
              "type": "string",
              "value": "={{ $now.setZone('America/Lima').toFormat('MMMM') }}"
            },
            {
              "id": "gs_year",
              "name": "A√±o",
              "type": "string",
              "value": "={{ $now.setZone('America/Lima').toFormat('yyyy') }}"
            },
            {
              "id": "gs1",
              "name": "ID_Pedido",
              "type": "string",
              "value": "={{ $json.pedido_finalizado_id }}"
            },
            {
              "id": "gs2",
              "name": "Cliente",
              "type": "string",
              "value": "={{ $json.nombre_cliente }}"
            },
            {
              "id": "gs3",
              "name": "Telefono",
              "type": "string",
              "value": "={{ $json.telefono_cliente }}"
            },
            {
              "id": "gs5",
              "name": "Monto_Total",
              "type": "number",
              "value": "={{ $json.total }}"
            },
            {
              "id": "gs8",
              "name": "Monto_Pagado",
              "type": "number",
              "value": "={{ $json.monto_pagado }}"
            },
            {
              "id": "gs9",
              "name": "Remitente_Pago",
              "type": "string",
              "value": "={{ $json.remitente }}"
            },
            {
              "id": "gs7",
              "name": "ID_Transaccion",
              "type": "string",
              "value": "={{ $json.pago_id }}"
            },
            {
              "id": "gs4",
              "name": "Detalle_Items",
              "type": "string",
              "value": "={{ $json.resumen_pedido }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2e4be805-dbc2-4766-b129-7df369416a3b",
      "name": "Set - Datos Google Sheets",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1008,
        1152
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "INSERT_SHEET_ID_HERE"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "Ventas"
        },
        "columns": {
          "mappingMode": "autoMapInputData"
        },
        "options": {}
      },
      "id": "b399bd5f-6e03-408c-8c98-995f7a02735f",
      "name": "Google Sheets - Registrar Venta",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -816,
        1152
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3cd803d5-38ec-4766-8eb8-585530774afd",
              "name": "mensaje_usuario",
              "value": "={{ $json.mensaje_usuario }}",
              "type": "string"
            },
            {
              "id": "f0297ad6-89bf-45ed-8bc1-85c2996d386c",
              "name": "mensaje_admin",
              "value": "={{ $json.mensaje_admin }}",
              "type": "string"
            },
            {
              "id": "62f7e23c-e305-47e4-af16-a3de346451e5",
              "name": "admin_phone",
              "value": "={{ $json.admin_phone }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1360,
        1312
      ],
      "id": "a85c89fc-9d1b-4786-9427-3aa7a132ce8a",
      "name": "Set - Datos Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5ece8381-75d7-4bb3-9fb0-2576011db9b2",
              "leftValue": "={{ $json.aprobado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1392,
        912
      ],
      "id": "2be905fa-801b-4844-83f4-d39d6b20610b",
      "name": "IF - Pago Aprobado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $('Set - Datos Imagen Pago').item.json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"messaging_product\": \"whatsapp\", \"to\": \"{{ $('Set - Datos Imagen Pago').item.json.telefono }}\", \"type\": \"text\", \"text\": { \"body\": \"{{ $json.mensaje_usuario }}\" }}",
        "options": {}
      },
      "id": "b92e3b4f-e955-436b-88e6-a84620902c06",
      "name": "HTTP - Msg Usuario",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1152,
        1312
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://graph.facebook.com/v21.0/' + $('Set - Datos Imagen Pago').item.json.phoneNumberId + '/messages' }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  \"messaging_product\": \"whatsapp\",\n  \"to\": $('Set - Datos Imagen Pago').item.json.telefono, \n  \"type\": \"image\",\n  \"image\": {\n    \"id\": $('Set - Datos Imagen Pago').first().json.media_id, \n    \"caption\": $json.mensaje_admin\n  }\n}) }}",
        "options": {}
      },
      "id": "4e9a519f-14ea-40a5-8c31-b18e2576403e",
      "name": "HTTP - Msg Admin",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1152,
        1488
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "Ur6ZELwtVtxItVPE",
          "name": "WhatsApp account"
        }
      }
    }
  ],
  "pinData": {
    "WhatsApp Trigger": [
      {
        "json": {
          "messaging_product": "whatsapp",
          "metadata": {
            "display_phone_number": "15551483724",
            "phone_number_id": "874504925746842"
          },
          "contacts": [
            {
              "profile": {
                "name": "mark"
              },
              "wa_id": "51978349180"
            }
          ],
          "messages": [
            {
              "from": "51978349180",
              "id": "wamid.HBgLNTE5NzgzNDkxODAVAgASGCBBQzA0NjA4QTQ2MDI5MkI4NDA2Q0Q3OUVFMDUwRkFGNgA=",
              "timestamp": "1763739382",
              "type": "image",
              "image": {
                "mime_type": "image/jpeg",
                "sha256": "UZFdmg3MQ6DVwDP/n9zrnppv7MV/QEHyeQltIAN3r8I=",
                "id": "1520582669160565"
              }
            }
          ],
          "field": "messages"
        }
      }
    ]
  },
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Switch - Tipo de mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - Tipo de mensaje": {
      "main": [
        [
          {
            "node": "Set - Datos Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DB - Procesar Ubicaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Set - Datos Bot√≥n WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Datos Imagen Pago",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Datos Cliente": {
      "main": [
        [
          {
            "node": "DB - Insertar o Actualizar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Set - Datos Bot√≥n WhatsApp": {
      "main": [
        [
          {
            "node": "Switch - Ruta Bot√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - Ruta Bot√≥n": {
      "main": [
        [
          {
            "node": "Set - Mensaje Men√∫",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP - Preguntar Tipo Entrega",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Tipo Recojo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Tipo Delivery",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Eliminar Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DB - Obtener Pedido Activo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Men√∫": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Men√∫",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Tipo Recojo": {
      "main": [
        [
          {
            "node": "DB - Crear Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Tipo Delivery": {
      "main": [
        [
          {
            "node": "DB - Crear Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Datos Imagen Pago": {
      "main": [
        [
          {
            "node": "DB - Guardar Comprobante y Finalizar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Resumen Staff": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Resumen Staff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Crear Pedido": {
      "main": [
        [
          {
            "node": "Set - Mensaje Pedir Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Obtener Pedido Activo": {
      "main": [
        [
          {
            "node": "GH - Obtener Carta1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - Enviar Men√∫": {
      "main": [
        []
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Switch - accion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Switch - accion": {
      "main": [
        [
          {
            "node": "Set - Mensaje Recurrente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Solicitar Informacion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Obtener mensaje",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GH - Obtener Carta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DB - Actualizar Estado a PENDIENTE_UBICACION",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "DB - Actualizar Pedido Detalle": {
      "main": [
        [
          {
            "node": "HTTP - Bot√≥n Confirmaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - Tipo Pedido": {
      "main": [
        [
          {
            "node": "DB - Actualizar Estado a PENDIENTE_DATOS_DELIVERY",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DB - Actualizar Estado a COMPLETO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Recojo": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Resumen Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Bienvenida": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Mensaje Interactivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Recurrente": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Mensaje Interactivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Pedir Datos Delivery": {
      "main": [
        [
          {
            "node": "HTTP - Mensaje Solicitar Informacion Delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Pedir Ubicaci√≥n": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Ubi msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Instrucciones de Pago": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Pago msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Insertar o Actualizar Cliente": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Actualizar Estado a PENDIENTE_DATOS_DELIVERY": {
      "main": [
        [
          {
            "node": "Set - Mensaje Pedir Datos Delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Actualizar Estado a COMPLETO": {
      "main": [
        [
          {
            "node": "Set - Mensaje Recojo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Actualizar Estado a PENDIENTE_UBICACION": {
      "main": [
        [
          {
            "node": "Set - Mensaje Pedir Ubicaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Guardar Comprobante y Finalizar Pedido": {
      "main": [
        [
          {
            "node": "If - Pedido Pagado Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Set - Mensaje Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DB - Obtener Pedido Activo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Pedir Pedido": {
      "main": [
        [
          {
            "node": "HTTP - Preguntar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Solicitar Informacion": {
      "main": [
        [
          {
            "node": "If - Hay Errores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - Hay Errores": {
      "main": [
        [
          {
            "node": "HTTP - Mensaje Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP - Preguntar Tipo Entrega",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar y armar pedido final": {
      "main": [
        [
          {
            "node": "DB - Actualizar Pedido Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GH - Obtener Carta": {
      "main": [
        [
          {
            "node": "Validar y armar pedido final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Obtener mensaje": {
      "main": [
        [
          {
            "node": "HTTP - Cancelar pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Eliminar Pedido": {
      "main": [
        [
          {
            "node": "HTTP - Eliminacion Exitosa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GH - Obtener Carta1": {
      "main": [
        [
          {
            "node": "JS - Parsear Carta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JS - Parsear Carta": {
      "main": [
        [
          {
            "node": "JS - Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JS - Preparar Contexto": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Procesar Ubicaci√≥n": {
      "main": [
        [
          {
            "node": "If - Pedido Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - Pedido Encontrado": {
      "main": [
        [
          {
            "node": "Set - Mensaje Instrucciones de Pago",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Mensaje Ubicacion Inesperada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Ubicacion Inesperada": {
      "main": [
        [
          {
            "node": "HTTP - Enviar Pago msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - Pedido Pagado Encontrado": {
      "main": [
        [
          {
            "node": "Download media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Mensaje Imagen Inesperada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Mensaje Imagen Inesperada": {
      "main": [
        [
          {
            "node": "HTTP - Mensaje error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Obtener Pedido Activo1": {
      "main": [
        [
          {
            "node": "Switch - Tipo Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Buscar Conciliaci√≥n": {
      "main": [
        [
          {
            "node": "JS - Validaci√≥n Cruzada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JS - Validaci√≥n Cruzada": {
      "main": [
        [
          {
            "node": "IF - Pago Aprobado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB - Validar pedido completo y completar": {
      "main": [
        [
          {
            "node": "Code - Resumen Staff",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set - Datos Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media": {
      "main": [
        [
          {
            "node": "HTTP - Download Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze an image": {
      "main": [
        [
          {
            "node": "JS - OCR Parseo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - Download Image": {
      "main": [
        [
          {
            "node": "Analyze an image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JS - OCR Parseo": {
      "main": [
        [
          {
            "node": "DB - Buscar Conciliaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Datos Google Sheets": {
      "main": [
        [
          {
            "node": "Google Sheets - Registrar Venta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - Pago Aprobado": {
      "main": [
        [
          {
            "node": "DB - Validar pedido completo y completar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set - Datos Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Datos Error": {
      "main": [
        [
          {
            "node": "HTTP - Msg Usuario",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP - Msg Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f75b5a57-69b6-43e8-b1f1-884433093705",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5c77fd69a044fc8332661839d745fcc4cdf4ca99c0317eb006f96ebbbb87b133"
  },
  "id": "WpgChVptMydZHMUu",
  "tags": []
}