{
  "type": "object",
  "properties": {
    "respuesta": {
      "type": "string",
      "description": "Texto final para el usuario. Debe ser amable y coherente con el estado actual."
    },
    "accion": {
      "type": "string",
      "description": "Determinante para el flujo de n8n. Define el siguiente paso lógico.",
      "enum": [
        "NONE",
        "MOSTRAR_CARTA",
        "INFO_PEDIDO",
        "INFO_DELIVERY",
        "ORDEN_DESCONOCIDA",
        "ESPERAR_UBICACION",
        "ESPERAR_PAGO",
        "SOLICITAR_CONFIRMACION"
      ]
    },
    "pedido_parseado": {
      "type": "array",
      "description": "Array de objetos. Solo se llena si se identifican productos válidos en el mensaje del usuario.",
      "items": {
        "type": "object",
        "properties": {
          "producto_id": {
            "type": "string",
            "description": "ID EXACTO del producto encontrado en el menú. Debes aplicar la lógica de emparejamiento semántico: si el usuario pide ingredientes combinados (X + Y), selecciona el ID del producto combinado correspondiente."
          },
          "producto_nombre": {
            "type": "string",
            "description": "Nombre oficial del producto según la carta."
          },
          "categoria_id": {
            "type": "string",
            "description": "ID de la categoría a la que pertenece el producto."
          },
          "cantidad": {
            "type": "integer",
            "minimum": 1,
            "description": "Número de unidades solicitadas."
          },
          "variant_id": {
            "type": "string",
            "description": "ID de la variante seleccionada. Si el usuario no especifica, usa la variante por defecto del menú."
          },
          "variant_label": {
            "type": "string",
            "description": "Nombre visible de la variante (ej: '01 Medium')."
          },
          "size_code": {
            "type": "string",
            "description": "Código técnico del tamaño (ej: '01_medium')."
          },
          "precio_unitario": {
            "type": "number",
            "description": "Precio extraído directamente del menú para esa variante."
          },
          "subtotal": {
            "type": "number",
            "description": "Cálculo matemático: precio_unitario * cantidad."
          }
        },
        "required": [
          "producto_id",
          "producto_nombre",
          "cantidad",
          "variant_id",
          "size_code",
          "precio_unitario",
          "subtotal"
        ]
      }
    },
    "total": {
      "type": "number",
      "description": "Suma total monetaria de todos los items del pedido_parseado. Si no hay pedido, es 0."
    },
    "resumen_pedido": {
      "type": "string",
      "description": "Bloque de texto formateado (con saltos de línea) describiendo el pedido completo y el total. Listo para ser leído por humanos."
    },
    "errores": {
      "type": "array",
      "description": "Lista de strings con problemas detectados (ej: 'Producto X no encontrado', 'Falta elegir tamaño'). Vacío si todo está bien.",
      "items": {
        "type": "string"
      }
    }
  },
  "required": [
    "respuesta",
    "accion",
    "pedido_parseado",
    "total",
    "resumen_pedido",
    "errores"
  ]
}